{% extends "layout.html" %}
{% block content %}
    <div class="content-section">
        <div class="media">
            <div class="position-relative">
                <img id="profile-image" class="rounded-circle account-img" src="{{ image_file }}">
                <div class="image-overlay position-absolute rounded-circle" style="display: none;">
                    <div class="d-flex flex-column align-items-center justify-content-center h-100">
                        <i class="fas fa-camera text-white mb-2" style="font-size: 24px;"></i>
                        <small class="text-white">Update</small>
                    </div>
                </div>
                <input type="file" id="picture-input" accept="image/*" class="d-none">
            </div>
            <div class="media-body ml-3">
                <h2 class="account-heading">{{current_user.username}}</h2>
                <p class="text-secondary">{{current_user.email}}</p>
                <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('picture-input').click()">
                    <i class="fas fa-upload"></i> Change Picture
                </button>
            </div>
        </div>
        
        <div class="content-section mt-4">
            <form method="POST" action="" enctype="multipart/form-data" id="account-form">
                {{ form.hidden_tag() }}
                <fieldset class="form-group">
                    <legend class="border-bottom mb-4">{{current_user.username}} Account</legend>
                    
                    <div class="form-group">
                        {{ form.username.label(class="form-control-label") }}
                        {% if form.username.errors %}
                            {{ form.username(class="form-control form-control-lg is-invalid") }}
                            <div class="invalid-feedback">
                                {% for error in form.username.errors %}
                                    <span>{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% else %}
                            {{ form.username(class="form-control form-control-lg") }}
                        {% endif %}
                        <small class="form-text text-muted">Choose a unique username</small>
                    </div>
                    
                    <div class="form-group">
                        {{ form.email.label(class="form-control-label") }}
                        {% if form.email.errors %}
                            {{ form.email(class="form-control form-control-lg is-invalid") }}
                            <div class="invalid-feedback">
                                {% for error in form.email.errors %}
                                    <span>{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% else %}
                            {{ form.email(class="form-control form-control-lg") }}
                        {% endif %}
                        <small class="form-text text-muted">We'll never share your email</small>
                    </div>
                    
                    <!-- Hidden file input for form submission -->
                    <div class="form-group d-none">
                        {{ form.picture.label() }}
                        {{ form.picture(class="form-control-file", id="form-picture") }}
                        {% if form.picture.errors %}
                            {% for error in form.picture.errors %}
                                <span class="text-danger">{{ error }}</span><br>
                            {% endfor %}
                        {% endif %}
                    </div>
                    
                    <!-- Image Preview Section -->
                    <div class="form-group" id="image-preview-section" style="display: none;">
                        <label class="form-control-label">New Picture Preview</label>
                        <div class="border rounded p-3 text-center">
                            <img id="preview-image" class="img-fluid rounded" style="max-height: 200px;">
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="cancelImageUpload()">
                                    <i class="fas fa-times"></i> Remove
                                </button>
                            </div>
                        </div>
                    </div>
                </fieldset>
                
                <div class="form-group">
                    {{ form.submit(class="btn btn-outline-info") }}
                    <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">Reset</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Cropping (Optional Enhancement) -->
    <div class="modal fade" id="cropModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Crop Profile Picture</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body text-center">
                    <div id="cropper-container" style="max-height: 400px; overflow: hidden;">
                        <img id="cropper-image" class="img-fluid">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="crop-save">Crop & Save</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        .position-relative {
            position: relative;
            display: inline-block;
        }
        
        .image-overlay {
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            cursor: pointer;
            transition: opacity 0.3s;
        }
        
        .account-img {
            width: 150px;
            height: 150px;
            object-fit: cover;
            transition: opacity 0.3s;
        }
        
        .position-relative:hover .image-overlay {
            display: flex !important;
        }
        
        .position-relative:hover .account-img {
            opacity: 0.8;
        }
    </style>

    <script>
        // DOM Elements
        const pictureInput = document.getElementById('picture-input');
        const formPicture = document.getElementById('form-picture');
        const previewImage = document.getElementById('preview-image');
        const profileImage = document.getElementById('profile-image');
        const imagePreviewSection = document.getElementById('image-preview-section');
        let cropper = null;
        
        // Trigger file input when overlay is clicked
        document.querySelector('.image-overlay').addEventListener('click', function() {
            pictureInput.click();
        });
        
        // Handle file selection
        pictureInput.addEventListener('change', function(e) {
            if (this.files && this.files[0]) {
                const file = this.files[0];
                
                // Validate file type
                if (!file.type.match('image.*')) {
                    alert('Please select an image file.');
                    return;
                }
                
                // Validate file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('Image size should be less than 5MB.');
                    return;
                }
                
                // Show preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    imagePreviewSection.style.display = 'block';
                    
                    // Update the form's hidden file input
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    formPicture.files = dataTransfer.files;
                    
                    // Optional: Show crop modal for better UX
                    // showCropModal(e.target.result);
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Remove selected image
        function cancelImageUpload() {
            pictureInput.value = '';
            formPicture.value = '';
            imagePreviewSection.style.display = 'none';
            previewImage.src = '';
        }
        
        // Reset form
        function resetForm() {
            document.getElementById('account-form').reset();
            cancelImageUpload();
        }
        
        // Optional: Crop functionality
        function showCropModal(imageSrc) {
            document.getElementById('cropper-image').src = imageSrc;
            $('#cropModal').modal('show');
            
            // Initialize cropper when modal is shown
            $('#cropModal').on('shown.bs.modal', function() {
                if (cropper) {
                    cropper.destroy();
                }
                const image = document.getElementById('cropper-image');
                cropper = new Cropper(image, {
                    aspectRatio: 1,
                    viewMode: 1,
                    autoCropArea: 0.8,
                });
            });
            
            // Handle crop save
            document.getElementById('crop-save').onclick = function() {
                if (cropper) {
                    const canvas = cropper.getCroppedCanvas({
                        width: 300,
                        height: 300,
                    });
                    
                    canvas.toBlob(function(blob) {
                        // Update preview with cropped image
                        previewImage.src = URL.createObjectURL(blob);
                        
                        // Update form file input
                        const file = new File([blob], 'profile_cropped.jpg', { type: 'image/jpeg' });
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(file);
                        formPicture.files = dataTransfer.files;
                        
                        // Also update the direct file input
                        pictureInput.files = dataTransfer.files;
                        
                        $('#cropModal').modal('hide');
                    }, 'image/jpeg');
                }
            };
            
            // Clean up cropper when modal is hidden
            $('#cropModal').on('hidden.bs.modal', function() {
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
            });
        }
        
        // Form validation before submission
        document.getElementById('account-form').addEventListener('submit', function(e) {
            const username = document.querySelector('[name="username"]').value.trim();
            const email = document.querySelector('[name="email"]').value.trim();
            
            if (!username || !email) {
                e.preventDefault();
                alert('Please fill in all required fields.');
                return;
            }
            
            // You can add more validation here
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                e.preventDefault();
                alert('Please enter a valid email address.');
                return;
            }
        });
    </script>
    
    <!-- Optional: Include Cropper.js for image cropping (add this in layout.html if you want cropping) -->
    <!--
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    -->
{% endblock content %}